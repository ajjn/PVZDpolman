# CMS aus xml extrahieren (BK-Signatur hat einen XML-Wrapper)
xmlstarlet sel -t -v '/sl:CreateCMSSignatureResponse' x.xml > x.cms


# CMS ist vom Tooling nicht so gut unterstützt wie XMLDSig (ASN.1 dump etc.)
# Daher besser mit XMLDSig weitermachen. 
# SAML-EDs werden als base64-codierte strings signiert. Das ist einfach und es gibt keine partiellen Signaturen.

# Bei der Signaturprüfung des SAML-ED ist zu prüfen:
# 1. Ist es eine gültige BK-Signatur?
# 2. Ist der Public Key des Signators in der Liste der Portaladministratoren
# 3. Sind die Domainnamen der Endpoint-URLs für die Organisation der Portaladministrators erlaubt?


## XML-signatur mit der Bürgerkarte von der Command Line erzeugen
## (Enveloping Signature, zu SignedContent ist komprimiert und base64 codiert, MIME-Type=text/plain)
creSigRequ.sh

## Extraktion des SignedContent aus der enveloping Signature:
xmlstarlet sel -t -c '//dsig:Object[1]/text()' idp5_valid.xml_sig.xml |base64 --decode | bzcat > idp5_valid.xml.orig

# Anmerkung: base64 -d entsprich unter OS X base64 -D -> --decode verwendent!

## Public Key aus einer BK XML-Signatur extrahieren
openssl x509 -pubkey -in rhoerbe_ecard_qcert_cer.pem -noout | grep -v '^---'

## Signature aus CreateSignatureRequest extrahieren:
# geht nicht mit etree, weil die Namespace Prefixes verändert werden. RegExp sind OK.

## Python - Java Integration
# Unter OSX muss man vor dem "import jnius" noch den DYLD_LIBRARY_PATH setzen, z.B.:
export DYLD_LIBRARY_PATH=/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/jre/lib/server

## Problem: jnius geht nicht mehr seit ca. 16.8.; Version vom 15.8. ist OK -> Rollback, Ursache suchen
PvzdVerfiySig = autoclass('PvzdVerifySig');
JavaException: Class not found 'PvzdVerifySig'
- Refactoring in spearates package verifysigapi
- Problem ist unabhängig von Python 2.7 und 3.4
- CLASSPATH ist in beiden Configs äquivalent
- Problem war fehlende make-Abhängigkeit zwischen den Modulen, nach refactoring fehlten die .class files

## junit test PvzdVerifySigTest geht nicht mehr - returns code 2203. 
Die Signaturpruefung hat folgenden Fehler geliefert:
Fehlercode: 2203
Fehlernachricht: TrustProfileID unbekannt: MOAIDBuergerkarteAuthentisierungsDaten
Was ist das? -> Doku moa-sp nachsehen wenn wieder on-line - möglicherweise weil test off-line ist

## PMPTestNoSign.py: append geht nicht mit Unicode contents unter python 2.7 
-> upgrade auf 3.4, OK

## ====== PEP ======
XMLValidator.java missing -> timemachine backup @home

# PEP:look up portaladmin via PubKey  OK

# struct OK, starting unittest with sigval

Umstellung auf python3.4 unvollständig, weiter mit 2.7 (str/bytes, str does not support buffer interface)